{
  "title": "Ex04:",
  "grafcet": "// 0. Initial Step (No Wait Action)\nS0 * \nS0 -> S1 : Start_Cycle\n\n// 1. Fill Tank A\nS1 \"EV1\"\nS1 -> S2 : Full\n\n// 2. Transfer A to B\nS2 \"EV2\"\nS2 -> S3 : Empty\n\n// 3. Heat & Mix\nS3 \"RC | MB\"\nS3 -> S4 : Temp_Reached\n\n// 4. Drain Tank B\nS4 \"EV3\"\nS4 -> S0 : Timer_Done",
  "svg": "<svg viewBox=\"0 0 600 450\" style=\"background:#f4f4f4; border-bottom: 4px solid #333; font-family: Arial, sans-serif;\"> \n  <defs> \n    <linearGradient id=\"water\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\"> \n      <stop offset=\"0%\" stop-color=\"#4fc3f7\"></stop> \n      <stop offset=\"100%\" stop-color=\"#0288d1\"></stop> \n    </linearGradient> \n    <filter id=\"shadow\"> <feDropShadow dx=\"1\" dy=\"1\" stdDeviation=\"1\"></feDropShadow> </filter> \n    <style>\n      @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&amp;display=swap');\n      .lcd-text { font-family: 'Courier New', monospace; font-weight: bold; letter-spacing: 2px; }\n    </style>\n  </defs> \n\n  <!-- PIPES BACKGROUND -->\n  <g fill=\"none\" stroke=\"#ccc\" stroke-width=\"8\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n    <path d=\"M 120,40 L 120,80 L 160,80\"></path> \n    <path d=\"M 220,140 L 260,140 L 260,100 L 300,100 L 300,200\"></path> \n    <path d=\"M 300,350 L 300,380 L 400,380 L 400,400\"></path> \n  </g>\n\n  <!-- ANIMATED FLOW (Dashed Lines) -->\n  <g fill=\"none\" stroke-width=\"4\" stroke-dasharray=\"8,8\">\n    <path id=\"flow1\" d=\"M 120,40 L 120,80 L 160,80\" stroke=\"#2196f3\" opacity=\"0\" stroke-dashoffset=\"-1446.400000000012\"></path>\n    <path id=\"flow2\" d=\"M 220,140 L 260,140 L 260,100 L 300,100 L 300,200\" stroke=\"#2196f3\" opacity=\"0\" stroke-dashoffset=\"-1888.0000000000182\"></path>\n    <path id=\"flow3\" d=\"M 300,350 L 300,380 L 400,380 L 400,400\" stroke=\"#f44336\" opacity=\"0\" stroke-dashoffset=\"-3407.999999999943\"></path>\n  </g>\n\n  <!-- TANK A (Weighing) --> \n  <g transform=\"translate(120, 80)\"> \n    <polygon points=\"20,0 120,0 100,60 40,60\" fill=\"rgba(255,255,255,0.8)\" stroke=\"#333\" stroke-width=\"2\"></polygon> \n    <path id=\"waterA\" d=\"M 19.90399999999996,59.71199999999988 L 80.09600000000003,59.71199999999988 L 100,60 L 40,60 Z\" fill=\"url(#water)\" opacity=\"0.9\"></path> \n    <text x=\"70\" y=\"30\" font-weight=\"bold\" fill=\"#333\" text-anchor=\"middle\">TANK A</text> \n    <!-- Weight Gauge -->\n    <g transform=\"translate(70,90)\">\n      <circle cx=\"0\" cy=\"0\" r=\"20\" fill=\"#fff\" stroke=\"#333\" stroke-width=\"2\"></circle>\n      <text x=\"0\" y=\"30\" font-size=\"10\" text-anchor=\"middle\">Kg</text>\n      <line id=\"needle\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"-16\" stroke=\"red\" stroke-width=\"2\" transform=\"rotate(-118.84799999999952)\"></line>\n      <circle cx=\"0\" cy=\"0\" r=\"2\" fill=\"#333\"></circle>\n    </g>\n  </g> \n\n  <!-- TANK B (Heating) --> \n  <g transform=\"translate(240, 200)\"> \n    <rect x=\"0\" y=\"0\" width=\"120\" height=\"150\" rx=\"10\" fill=\"rgba(255,255,255,0.8)\" stroke=\"#333\" stroke-width=\"2\"></rect> \n    <rect id=\"waterB\" x=\"5\" y=\"145\" width=\"110\" height=\"0\" rx=\"5\" fill=\"url(#water)\" opacity=\"0.9\"></rect> \n    <text x=\"60\" y=\"25\" font-weight=\"bold\" fill=\"#333\" text-anchor=\"middle\">TANK B</text> \n    \n    <!-- Heater (RC) --> \n    <polyline points=\"20,130 30,120 40,130 50,120 60,130 70,120 80,130 90,120 100,130\" fill=\"none\" stroke=\"#555\" stroke-width=\"3\" id=\"heater\"></polyline> \n    <text x=\"15\" y=\"145\" font-size=\"10\" font-weight=\"bold\">RC</text> \n\n    <!-- RESTORED THERMOMETER (Theta) -->\n    <g transform=\"translate(-15, 20)\">\n        <!-- Probe -->\n        <line x1=\"15\" y1=\"30\" x2=\"30\" y2=\"30\" stroke=\"#999\" stroke-width=\"4\"></line>\n        <!-- Glass Tube -->\n        <rect x=\"0\" y=\"0\" width=\"14\" height=\"80\" rx=\"7\" fill=\"#fff\" stroke=\"#333\" stroke-width=\"1\"></rect>\n        <rect x=\"5\" y=\"5\" width=\"4\" height=\"70\" rx=\"2\" fill=\"#eee\"></rect>\n        <!-- Mercury Animated -->\n        <rect id=\"therm-level\" x=\"5\" y=\"75\" width=\"4\" height=\"0\" rx=\"2\" fill=\"#d32f2f\"></rect>\n        <!-- Bulb -->\n        <circle cx=\"7\" cy=\"85\" r=\"10\" fill=\"#d32f2f\" stroke=\"#333\"></circle>\n        <!-- Ticks -->\n        <line x1=\"14\" y1=\"20\" x2=\"18\" y2=\"20\" stroke=\"#333\"></line>\n        <line x1=\"14\" y1=\"40\" x2=\"18\" y2=\"40\" stroke=\"#333\"></line>\n        <line x1=\"14\" y1=\"60\" x2=\"18\" y2=\"60\" stroke=\"#333\"></line>\n        <text x=\"-15\" y=\"40\" font-size=\"14\" fill=\"#d32f2f\" font-weight=\"bold\">θ</text>\n    </g>\n\n    <!-- Mixer (MB) RIGHT SIDE --> \n    <g transform=\"translate(120, 50)\">\n        <rect x=\"0\" y=\"-20\" width=\"40\" height=\"40\" rx=\"5\" fill=\"#555\" stroke=\"#333\"></rect>\n        <text x=\"20\" y=\"5\" fill=\"white\" font-size=\"10\" text-anchor=\"middle\">MB</text>\n        <line x1=\"0\" y1=\"0\" x2=\"-60\" y2=\"0\" stroke=\"#333\" stroke-width=\"4\"></line>\n        <!-- Restored Propeller Blade -->\n        <g id=\"propeller\" transform=\"translate(-60,0) rotate(1638.400000000006)\">\n             <line x1=\"0\" y1=\"-30\" x2=\"0\" y2=\"30\" stroke=\"#333\" stroke-width=\"4\"></line>\n             <ellipse cx=\"0\" cy=\"-25\" rx=\"8\" ry=\"20\" fill=\"#666\" stroke=\"#333\"></ellipse>\n             <ellipse cx=\"0\" cy=\"25\" rx=\"8\" ry=\"20\" fill=\"#666\" stroke=\"#333\"></ellipse>\n             <circle cx=\"0\" cy=\"0\" r=\"6\" fill=\"#eee\" stroke=\"#333\"></circle>\n        </g>\n    </g>\n  </g> \n\n  <!-- VALVES --> \n  <g id=\"v1\" transform=\"translate(120, 50)\"><path d=\"M -10,-5 L 10,5 L -10,5 L 10,-5 Z\" fill=\"#fff\" stroke=\"#000\"></path><text x=\"15\" y=\"0\" font-size=\"11\">EV1</text></g> \n  <g id=\"v2\" transform=\"translate(260, 120)\"><path d=\"M -5,-10 L 5,10 L 5,-10 L -5,10 Z\" fill=\"#fff\" stroke=\"#000\"></path><text x=\"-25\" y=\"0\" font-size=\"11\">EV2</text></g> \n  <g id=\"v3\" transform=\"translate(400, 380)\"><path d=\"M -10,-5 L 10,5 L -10,5 L 10,-5 Z\" fill=\"#fff\" stroke=\"#000\"></path><text x=\"15\" y=\"0\" font-size=\"11\">EV3</text></g> \n\n  <!-- TIMER VISUAL -->\n  <g id=\"timer-group\" transform=\"translate(450, 350)\" opacity=\"0.3\"> \n    <circle cx=\"0\" cy=\"0\" r=\"20\" fill=\"none\" stroke=\"#ddd\" stroke-width=\"4\"></circle> \n    <circle id=\"timer-arc\" cx=\"0\" cy=\"0\" r=\"20\" fill=\"none\" stroke=\"#f44336\" stroke-width=\"4\" stroke-dasharray=\"125\" stroke-dashoffset=\"125\" transform=\"rotate(-90)\"></circle> \n  </g> \n\n  <!-- WHITE HMI DASHBOARD --> \n  <g transform=\"translate(400, 20)\"> \n    <rect x=\"0\" y=\"0\" width=\"180\" height=\"220\" rx=\"5\" fill=\"#ffffff\" stroke=\"#999\" stroke-width=\"2\" filter=\"url(#shadow)\"></rect> \n    <text x=\"90\" y=\"20\" fill=\"#333\" font-family=\"Arial\" font-size=\"12\" font-weight=\"bold\" text-anchor=\"middle\">OPERATOR PANEL</text>\n    <line x1=\"10\" y1=\"30\" x2=\"170\" y2=\"30\" stroke=\"#eee\" stroke-width=\"2\"></line>\n\n    <!-- LCD Screens -->\n    <g transform=\"translate(15, 45)\">\n      <text x=\"0\" y=\"0\" font-size=\"10\" fill=\"#555\">WEIGHT A (Kg)</text>\n      <rect x=\"0\" y=\"5\" width=\"150\" height=\"30\" fill=\"#f0f8ff\" stroke=\"#b0bec5\"></rect>\n      <text id=\"lcd-weight\" x=\"140\" y=\"28\" class=\"lcd-text\" font-size=\"20\" fill=\"#0277bd\" text-anchor=\"end\">000</text>\n      \n      <text x=\"0\" y=\"55\" font-size=\"10\" fill=\"#555\">TEMP B (°C)</text>\n      <rect x=\"0\" y=\"60\" width=\"150\" height=\"30\" fill=\"#fff0f0\" stroke=\"#b0bec5\"></rect>\n      <text id=\"lcd-temp\" x=\"140\" y=\"83\" class=\"lcd-text\" font-size=\"20\" fill=\"#d32f2f\" text-anchor=\"end\">19.9</text>\n\n      <text x=\"0\" y=\"110\" font-size=\"10\" fill=\"#555\">DRAIN TIMER (s)</text>\n      <rect x=\"0\" y=\"115\" width=\"150\" height=\"30\" fill=\"#f1f8e9\" stroke=\"#b0bec5\"></rect>\n      <text id=\"lcd-timer\" x=\"140\" y=\"138\" class=\"lcd-text\" font-size=\"20\" fill=\"#2e7d32\" text-anchor=\"end\">05.0</text>\n    </g>\n\n    <!-- Buttons -->\n    <g transform=\"translate(20, 190)\">\n       <rect x=\"0\" y=\"0\" width=\"40\" height=\"20\" rx=\"10\" fill=\"#ddd\" id=\"switch-bg\" onclick=\"toggleAuto()\"></rect>\n       <circle cx=\"10\" cy=\"10\" r=\"8\" fill=\"#fff\" stroke=\"#999\" id=\"switch-knob\" style=\"transition:cx 0.2s\"></circle>\n       <text x=\"45\" y=\"14\" font-size=\"10\" fill=\"#333\">AUTO</text>\n       \n       <circle id=\"btn-dcy\" cx=\"110\" cy=\"10\" r=\"12\" fill=\"#ccc\" stroke=\"#999\" stroke-width=\"2\" cursor=\"pointer\" onmousedown=\"pressDcy()\"></circle>\n       <text x=\"110\" y=\"35\" text-anchor=\"middle\" fill=\"#555\" font-size=\"9\">START</text>\n    </g>\n  </g> \n</svg>",
  "initialState": {
    "lvlA": 0.4800000000002014,
    "lvlB": 0,
    "temp": 19.920000000001124,
    "mixerAngle": 1638.400000000006,
    "timer": 0,
    "auto": false,
    "dcyPressed": false,
    "offset": -19283.20000000219
  },
  "logic": "// --- CONSTANTS ---\nconst FILL_RATE = 40;\nconst TRANSFER_RATE = 45;\nconst DRAIN_RATE = 50;\nconst HEAT_RATE = 15;\nconst MAX_A = 100;\nconst MAX_B = 100;\nconst TARGET_TEMP = 80;\nconst MAX_TIME = 3.5;\n\n// --- HELPERS ---\nif(!window.toggleAuto) { window.toggleAuto = function() { state.auto = !state.auto; }; }\nif(!window.pressDcy) { window.pressDcy = function() { state.dcyPressed = true; setTimeout(() => state.dcyPressed = false, 300); }; }\n\n// --- PHYSICS ---\n\n// 1. Fill A\nif (inputs[\"EV1\"]) {\n    state.lvlA += FILL_RATE * dt;\n    if(state.lvlA > MAX_A) state.lvlA = MAX_A;\n}\n\n// 2. Transfer A->B\nif (inputs[\"EV2\"]) {\n    const amt = TRANSFER_RATE * dt;\n    if (state.lvlA > 0) {\n        state.lvlA -= amt;\n        state.lvlB += amt;\n        if(state.lvlA < 0) state.lvlA = 0;\n        if(state.lvlB > MAX_B) state.lvlB = MAX_B;\n    }\n}\n\n// 3. Heat & Mix (Action name: RC | MB)\nif (inputs[\"RC | MB\"]) {\n    state.temp += HEAT_RATE * dt;\n    if(state.temp > 100) state.temp = 100;\n    state.mixerAngle += 400 * dt;\n} else if (state.temp > 20) {\n    state.temp -= 5 * dt;\n}\n\n// 4. Drain\nif (inputs[\"EV3\"]) {\n    state.lvlB -= DRAIN_RATE * dt;\n    if(state.lvlB < 0) state.lvlB = 0;\n    state.timer += dt;\n} else {\n    state.timer = 0;\n}\n\n// Flow Dash Offset\nstate.offset -= 200 * dt;\n\n// --- VISUALIZATION ---\n\n// Water A\nconst pctA = state.lvlA / MAX_A;\nconst hA = 60 * pctA;\nconst yTop = 60 - hA;\nconst wTop = 60 + (40 * pctA);\nconst xOff = (100 - wTop) / 2;\nconst dWaterA = `M ${xOff},${yTop} L ${100-xOff},${yTop} L 100,60 L 40,60 Z`;\nsvg.querySelector('#waterA').setAttribute('d', dWaterA);\n\n// Weight Needle\nconst angle = -120 + (240 * pctA);\nsvg.querySelector('#needle').setAttribute('transform', `rotate(${angle})`);\n\n// Water B & Color Change\nconst hB = 145 * (state.lvlB / MAX_B);\nconst wB = svg.querySelector('#waterB');\nwB.setAttribute('height', hB);\nwB.setAttribute('y', 145 - hB);\n\nconst t = Math.min(Math.max((state.temp - 20) / (TARGET_TEMP - 20), 0), 1);\nlet r, g, b;\nif (t < 0.5) {\n    const localT = t * 2;\n    r = 33 + (100 * localT);\n    g = 150 - (150 * localT);\n    b = 243;\n} else {\n    const localT = (t - 0.5) * 2;\n    r = 133 + (111 * localT);\n    g = 0;\n    b = 243 - (189 * localT);\n}\nconst col = (state.lvlB > 1) ? `rgb(${Math.floor(r)},${Math.floor(g)},${Math.floor(b)})` : 'url(#water)';\nwB.setAttribute('fill', col);\n\n// *** THERMOMETER ANIMATION ***\nconst thermLevel = svg.querySelector('#therm-level');\nconst thermH = Math.max(0, ((state.temp - 20) / 80) * 70);\nthermLevel.setAttribute('height', thermH);\nthermLevel.setAttribute('y', 75 - thermH);\n\n// Components Update\nsvg.querySelector('#propeller').setAttribute('transform', `translate(-60,0) rotate(${state.mixerAngle})`);\nsvg.querySelector('#heater').setAttribute('stroke', inputs[\"RC | MB\"] ? '#d32f2f' : '#555');\nsvg.querySelector('#v1 path').setAttribute('fill', inputs[\"EV1\"] ? '#00e676' : '#fff');\nsvg.querySelector('#v2 path').setAttribute('fill', inputs[\"EV2\"] ? '#00e676' : '#fff');\nsvg.querySelector('#v3 path').setAttribute('fill', inputs[\"EV3\"] ? '#00e676' : '#fff');\n\n// Flow Lines\nconst setFlow = (id, active) => {\n    const el = svg.querySelector(id);\n    if(active) {\n        el.setAttribute('opacity', 1);\n        el.setAttribute('stroke-dashoffset', state.offset);\n    } else {\n        el.setAttribute('opacity', 0);\n    }\n};\nsetFlow('#flow1', inputs[\"EV1\"]);\nsetFlow('#flow2', inputs[\"EV2\"]);\nsetFlow('#flow3', inputs[\"EV3\"]);\n\n// LCD Logic\nsvg.querySelector('#lcd-weight').textContent = Math.round(state.lvlA).toString().padStart(3, '0');\nsvg.querySelector('#lcd-temp').textContent = state.temp.toFixed(1);\nconst timeLeft = Math.max(0, MAX_TIME - state.timer);\nsvg.querySelector('#lcd-timer').textContent = inputs[\"EV3\"] ? timeLeft.toFixed(1).padStart(4,'0') : '05.0';\n\n// Timer Visual\nconst timerGrp = svg.querySelector('#timer-group');\nconst timerArc = svg.querySelector('#timer-arc');\nif(inputs[\"EV3\"]) {\n    timerGrp.setAttribute('opacity', 1);\n    const dash = 125 * (1 - (state.timer / MAX_TIME));\n    timerArc.setAttribute('stroke-dashoffset', 125 - dash);\n} else {\n    timerGrp.setAttribute('opacity', 0.3);\n    timerArc.setAttribute('stroke-dashoffset', 125);\n}\n\n// Buttons\nconst btn = svg.querySelector('#btn-dcy');\nbtn.setAttribute('fill', (state.dcyPressed || state.auto) ? '#69f0ae' : '#ccc');\nconst knob = svg.querySelector('#switch-knob');\nconst bg = svg.querySelector('#switch-bg');\nif(state.auto) { knob.setAttribute('cx', 30); bg.setAttribute('fill', '#4caf50'); } \nelse { knob.setAttribute('cx', 10); bg.setAttribute('fill', '#ddd'); }\n\nreturn {\n    Start_Cycle: state.auto || state.dcyPressed,\n    Full: state.lvlA >= 99,\n    Empty: state.lvlA <= 1,\n    Temp_Reached: state.temp >= TARGET_TEMP,\n    Timer_Done: state.timer >= MAX_TIME\n};",
  "layout": {
    "nodes": {
      "S0": {
        "x": 18.888887405395508,
        "y": 68.11111068725586
      },
      "S1": {
        "x": 20,
        "y": 154
      },
      "S2": {
        "x": 19.947368621826172,
        "y": 255.57894897460938
      },
      "S3": {
        "x": 20.42105197906494,
        "y": 362.21051025390625
      },
      "S4": {
        "x": 21,
        "y": 466.47369384765625
      },
      "T_0": {
        "x": 20,
        "y": 110
      },
      "T_1": {
        "x": 20,
        "y": 202
      },
      "T_2": {
        "x": 19.947368621826172,
        "y": 308.3157958984375
      },
      "T_3": {
        "x": 20.473684310913086,
        "y": 413.6842041015625
      },
      "T_4": {
        "x": 21.842105865478516,
        "y": 522.1052856445312
      }
    },
    "loops": {
      "T_4-S0": 149.99999237060547
    }
  }
}