{
  "title": "Ex05",
  "grafcet": "// 0. Idle State\nS0 * \nS0 -> S1 : m . a0 . b1 . t\nS0 -> S3 : m . a0 . b1 . p\n\n// --- BRANCH 1: PYRAMID (Push to Bin 1) ---\nS1 \"A+\"\nS1 -> S2 : a1\n\nS2 \"A-\"\nS2 -> S0 : a0\n\n// --- BRANCH 2: PRISM (Open Gate for Bin 2) ---\nS3 \"B-\"\nS3 -> S4 : b0\n\nS4 \nS4 -> S5 : b2\n\nS5 \"B+\"\nS5 -> S0 : b1",
  "svg": "<svg viewBox=\"0 0 600 450\" style=\"background:#f5f5f5; border: 2px solid #333; font-family: Roboto, Arial, sans-serif;\"> \n  <defs> \n    <!-- Metallic Gradients -->\n    <linearGradient id=\"metal-body\" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"0\"> \n      <stop offset=\"0%\" stop-color=\"#546e7a\"></stop> \n      <stop offset=\"30%\" stop-color=\"#b0bec5\"></stop> \n      <stop offset=\"60%\" stop-color=\"#eceff1\"></stop> \n      <stop offset=\"90%\" stop-color=\"#546e7a\"></stop> \n    </linearGradient>\n    <linearGradient id=\"rod-grad\" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"0\">\n      <stop offset=\"0%\" stop-color=\"#78909c\"></stop>\n      <stop offset=\"50%\" stop-color=\"#ffffff\"></stop>\n      <stop offset=\"100%\" stop-color=\"#78909c\"></stop>\n    </linearGradient>\n    <!-- Shadows & Filters -->\n    <filter id=\"shadow-parts\"> <feDropShadow dx=\"2\" dy=\"4\" stdDeviation=\"2\" opacity=\"0.4\"></feDropShadow> </filter>\n    <filter id=\"shadow-ui\"> <feDropShadow dx=\"0\" dy=\"2\" stdDeviation=\"3\" opacity=\"0.2\"></feDropShadow> </filter>\n  </defs> \n\n  <!-- 1. ENVIRONMENT (Floor) -->\n  <path d=\"M 0,250 L 600,250 L 600,450 L 0,450 Z\" fill=\"#e0e0e0\"></path>\n\n  <!-- 2. BIN BACK WALLS (Behind everything) -->\n  <!-- Bin 1 Back (Pyramids) -->\n  <g transform=\"translate(310, 310)\">\n      <path d=\"M 0,0 L 90,0 L 90,70 L 0,70 Z\" fill=\"#9e9e9e\"></path>\n      <path d=\"M 0,70 L 90,70 L 70,90 L -20,90 Z\" fill=\"#bdbdbd\"></path>\n  </g>\n  <!-- Bin 2 Back (Prisms) -->\n  <g transform=\"translate(480, 260)\">\n      <path d=\"M 0,0 L 80,0 L 80,80 L 0,80 Z\" fill=\"#9e9e9e\"></path>\n      <path d=\"M 0,80 L 80,80 L 60,100 L -20,100 Z\" fill=\"#bdbdbd\"></path>\n  </g>\n\n  <!-- 3. CONVEYOR BELT (Middle Layer) -->\n  <g transform=\"translate(0, 200)\">\n      <!-- Belt Surface -->\n      <path d=\"M 0,20 L 450,20 L 420,50 L -30,50 Z\" fill=\"#424242\" stroke=\"#212121\"></path>\n      <!-- Side Rail -->\n      <path d=\"M -30,50 L 420,50 L 420,60 L -30,60 Z\" fill=\"#616161\"></path>\n      <!-- Legs -->\n      <path d=\"M 50,60 L 50,200 L 60,200 L 60,60 Z\" fill=\"#333\"></path>\n      <path d=\"M 350,60 L 350,200 L 360,200 L 360,60 Z\" fill=\"#333\"></path>\n  </g>\n\n  <!-- 4. CYLINDER RODS (Moving Parts) -->\n  <!-- Rod A (Vertical) -->\n  <g transform=\"translate(335, 90)\">\n     <rect id=\"rod-a\" x=\"-4\" y=\"40\" width=\"8\" height=\"0\" fill=\"url(#rod-grad)\" stroke=\"#546e7a\" stroke-width=\"0.5\"></rect>\n  </g>\n  <!-- Rod B (Horizontal) -->\n  <g transform=\"translate(420, 195) skewX(-45)\">\n     <rect id=\"rod-b\" x=\"-60\" y=\"0\" width=\"60\" height=\"8\" fill=\"url(#rod-grad)\" stroke=\"#546e7a\" stroke-width=\"0.5\"></rect>\n  </g>\n\n  <!-- 5. CYLINDER HOUSINGS (Stationary, Draw OVER Rods for 'Inside' look) -->\n  <!-- Cylinder A (Vertical) -->\n  <g transform=\"translate(335, 90)\">\n    <!-- Housing Body -->\n    <rect x=\"-15\" y=\"-40\" width=\"30\" height=\"80\" fill=\"url(#metal-body)\" stroke=\"#37474f\"></rect>\n    <!-- Bottom Cap/Seal (Crucial for 3D effect) -->\n    <path d=\"M -15,40 A 15 5 0 0 0 15 40 L 15 35 L -15 35 Z\" fill=\"#455a64\"></path>\n    <ellipse cx=\"0\" cy=\"40\" rx=\"5\" ry=\"2\" fill=\"#263238\"></ellipse> <!-- The hole -->\n    <!-- Sensors -->\n    <circle id=\"sens-a0\" cx=\"22\" cy=\"-30\" r=\"3\" fill=\"#00e676\" stroke=\"white\"></circle><text x=\"30\" y=\"-27\" font-size=\"9\" fill=\"#555\">a0</text>\n    <circle id=\"sens-a1\" cx=\"22\" cy=\"30\" r=\"3\" fill=\"#333\" stroke=\"white\"></circle><text x=\"30\" y=\"33\" font-size=\"9\" fill=\"#555\">a1</text>\n  </g>\n\n  <!-- Cylinder B (Horizontal) -->\n  <g transform=\"translate(420, 195)\">\n     <g transform=\"skewX(-45)\">\n        <rect x=\"50\" y=\"-10\" width=\"80\" height=\"25\" fill=\"url(#metal-body)\" stroke=\"#37474f\"></rect>\n        <!-- End Cap/Seal -->\n        <path d=\"M 50,-10 L 50,15 A 5 12 0 0 1 45,15 L 45,-10\" fill=\"#455a64\"></path>\n     </g>\n     <!-- Sensors -->\n     <circle id=\"sens-b1\" cx=\"120\" cy=\"-25\" r=\"3\" fill=\"#00e676\" stroke=\"white\"></circle><text x=\"115\" y=\"-32\" font-size=\"9\" fill=\"#555\">b1</text>\n     <circle id=\"sens-b0\" cx=\"60\" cy=\"-25\" r=\"3\" fill=\"#333\" stroke=\"white\"></circle><text x=\"55\" y=\"-32\" font-size=\"9\" fill=\"#555\">b0</text>\n  </g>\n\n  <!-- 6. ITEMS LAYER (Stacked Items) -->\n  <g id=\"parts-layer\"><g transform=\"translate(501.99999999999676, 350)\" filter=\"url(#shadow-parts)\" opacity=\"1\"><path d=\"M 0,0 L 30,0 L 30,20 L 0,20 Z M 0,0 L 10,-10 L 40,-10 L 30,0 Z M 30,0 L 40,-10 L 40,10 L 30,20 Z\" fill=\"#29b6f6\" stroke=\"#0277bd\" stroke-linejoin=\"round\"></path></g><g transform=\"translate(333.68000000000035, 380)\" filter=\"url(#shadow-parts)\" opacity=\"1\"><path d=\"M 0,20 L 15,-10 L 30,20 L 0,20 Z M 30,20 L 15,-10 L 40,0 L 40,30 L 30,20 Z\" fill=\"#ffeb3b\" stroke=\"#f9a825\" stroke-linejoin=\"round\"></path></g><g transform=\"translate(350, 217.548)\" filter=\"url(#shadow-parts)\" opacity=\"1\"><path d=\"M 0,20 L 15,-10 L 30,20 L 0,20 Z M 30,20 L 15,-10 L 40,0 L 40,30 L 30,20 Z\" fill=\"#ffeb3b\" stroke=\"#f9a825\" stroke-linejoin=\"round\"></path></g></g>\n\n  <!-- 7. PUSHER PLATES (Attached to ends of Rods) -->\n  <!-- Plate A -->\n  <g transform=\"translate(335, 90)\">\n      <path id=\"plate-a\" d=\"M -25,40 L 25,40 L 15,50 L -35,50 Z\" fill=\"#5d4037\" stroke=\"#3e2723\" stroke-width=\"1\" transform=\"translate(0, 0)\"></path>\n  </g>\n  <!-- Plate B (Gate) -->\n  <g transform=\"translate(420, 195)\">\n      <path id=\"plate-b\" d=\"M -5,-10 L 5,-10 L -5,20 L -15,20 Z\" fill=\"#5d4037\" stroke=\"#3e2723\" transform=\"translate(-60, 0)\"></path>\n  </g>\n\n  <!-- 8. BIN FRONTS (Foreground Glass) -->\n  <!-- Bin 1 Front -->\n  <g transform=\"translate(310, 310)\">\n      <path d=\"M 0,0 L -20,20 L -20,90 L 0,70 Z\" fill=\"#bdbdbd\" stroke=\"#757575\"></path>\n      <path d=\"M -20,90 L 70,90 L 70,40 L -20,40 Z\" fill=\"rgba(33, 150, 243, 0.2)\" stroke=\"#2196f3\" stroke-width=\"2\"></path>\n      <text x=\"25\" y=\"80\" fill=\"#333\" font-size=\"10\" font-weight=\"bold\" opacity=\"0.5\">BIN 1</text>\n  </g>\n  <!-- Bin 2 Front -->\n  <g transform=\"translate(480, 260)\">\n      <path d=\"M 0,0 L -20,20 L -20,100 L 0,80 Z\" fill=\"#bdbdbd\" stroke=\"#757575\"></path>\n      <path d=\"M -20,100 L 60,100 L 60,50 L -20,50 Z\" fill=\"rgba(33, 150, 243, 0.2)\" stroke=\"#2196f3\" stroke-width=\"2\"></path>\n      <text x=\"20\" y=\"90\" fill=\"#333\" font-size=\"10\" font-weight=\"bold\" opacity=\"0.5\">BIN 2</text>\n  </g>\n\n  <!-- 9. DASHBOARD (Top) -->\n  <g transform=\"translate(10, 5)\">\n      <rect width=\"150\" height=\"100\" rx=\"5\" fill=\"white\" stroke=\"#ccc\" filter=\"url(#shadow-ui)\"></rect>\n      <rect width=\"150\" height=\"25\" rx=\"5\" fill=\"#eceff1\"></rect>\n      <text x=\"75\" y=\"17\" text-anchor=\"middle\" font-weight=\"bold\" font-size=\"11\" fill=\"#455a64\">CONTROL PANEL</text>\n      \n      <!-- Status -->\n      <g transform=\"translate(10, 40)\">\n          <circle id=\"led-m\" r=\"4\" fill=\"#00e676\"></circle>\n          <text x=\"10\" y=\"4\" font-size=\"10\" fill=\"#555\">SYSTEM ACTIVE</text>\n      </g>\n      \n      <!-- Sensors Matrix -->\n      <g transform=\"translate(10, 60)\">\n         <text x=\"0\" y=\"0\" font-size=\"9\" fill=\"#999\">I/O SENSORS:</text>\n         <text x=\"0\" y=\"12\" font-family=\"monospace\" font-size=\"9\" fill=\"#555\">A0[<tspan id=\"txt-a0\" fill=\"#00c853\">o</tspan>] A1[<tspan id=\"txt-a1\" fill=\"#b0bec5\">o</tspan>]</text>\n         <text x=\"0\" y=\"24\" font-family=\"monospace\" font-size=\"9\" fill=\"#555\">B0[<tspan id=\"txt-b0\" fill=\"#b0bec5\">o</tspan>] B1[<tspan id=\"txt-b1\" fill=\"#00c853\">o</tspan>] B2[<tspan id=\"txt-b2\" fill=\"#b0bec5\">o</tspan>]</text>\n      </g>\n      \n      <!-- Detection -->\n      <g transform=\"translate(85, 50)\">\n          <rect x=\"0\" y=\"0\" width=\"55\" height=\"40\" rx=\"3\" fill=\"#f5f5f5\" stroke=\"#ddd\"></rect>\n          <text x=\"27\" y=\"15\" text-anchor=\"middle\" font-size=\"8\" fill=\"#aaa\">DETECT</text>\n          <circle id=\"led-detect\" cx=\"27\" cy=\"28\" r=\"6\" fill=\"#ffeb3b\"></circle>\n      </g>\n  </g>\n\n  <!-- START BUTTON -->\n  <g transform=\"translate(10, 400)\" cursor=\"pointer\" onmousedown=\"toggleM()\">\n      <rect width=\"100\" height=\"30\" rx=\"15\" fill=\"#4caf50\" stroke=\"#2e7d32\" filter=\"url(#shadow-ui)\"></rect>\n      <text x=\"50\" y=\"20\" text-anchor=\"middle\" fill=\"white\" font-weight=\"bold\" font-size=\"11\">START / STOP</text>\n  </g>\n\n</svg>",
  "initialState": {
    "a_pos": 0,
    "b_pos": 100,
    "m": true,
    "parts": [   ],
    "timer": 0,
    "b2_timer": -0.01200000000000033,
    "bin1_count": 0,
    "bin2_count": 0
  },
  "logic": "// --- CONSTANTS ---\nconst SPEED_CONV = 60;   \nconst SPEED_CYL = 150;   \nconst STOP_X = 350;\n\n// --- HELPERS ---\nif(!window.toggleM) window.toggleM = () => state.m = !state.m;\n\n// --- 1. ACTUATORS ---\n// Cylinder A (Vertical)\nif (inputs['A+']) state.a_pos += SPEED_CYL * dt;\nelse if (inputs['A-']) state.a_pos -= SPEED_CYL * dt;\nstate.a_pos = Math.max(0, Math.min(100, state.a_pos));\n\n// Cylinder B (Horizontal Gate)\nif (inputs['B+']) state.b_pos += SPEED_CYL * dt;\nelse if (inputs['B-']) state.b_pos -= SPEED_CYL * dt;\nstate.b_pos = Math.max(0, Math.min(100, state.b_pos));\n\n// --- 2. GENERATOR ---\nconst isHome = state.a_pos <= 1 && state.b_pos >= 99;\n// Logic: Only generate if no part is currently moving on the belt\nconst movingPart = state.parts.find(p => p.state === 'move' || p.state === 'fall1' || p.state === 'fall2');\n\nif (state.m && !movingPart && isHome) {\n    state.timer += dt;\n    if (state.timer > 0.8) {\n        const type = Math.random() > 0.5 ? 'pyr' : 'prism';\n        state.parts.push({ x: 0, y: 200, type: type, state: 'move', trig_b2: false, opacity: 1, stackIdx: 0 });\n        state.timer = 0;\n    }\n} else {\n    state.timer = 0;\n}\n\n// --- 3. PHYSICS & STACKING ---\nlet s_t = false;\nlet s_p = false;\n\nif (state.b2_timer > 0) state.b2_timer -= dt;\n\nconst gateClosed = state.b_pos > 80;\n\n// Bin Floor Levels (Visual Y)\nconst BIN1_FLOOR = 380;\nconst BIN2_FLOOR = 350;\n\n// Filter out parts that have fully faded out\nstate.parts = state.parts.filter(p => p.opacity > 0.05);\n\n// Count items in rest state per bin to manage stacking\nlet bin1Items = state.parts.filter(p => p.state === 'rest' && p.bin === 1);\nlet bin2Items = state.parts.filter(p => p.state === 'rest' && p.bin === 2);\n\n// FADE OUT LOGIC: If > 5 items, fade out the oldest ones\nif (bin1Items.length > 5) {\n    // Sort by Y (bottom items are usually lower Y... wait, lower Y is higher up? No, higher Y is lower screen)\n    // Actually just fade the first ones in the array assuming FIFO\n    bin1Items[0].opacity -= 2 * dt;\n}\nif (bin2Items.length > 5) {\n    bin2Items[0].opacity -= 2 * dt;\n}\n\nstate.parts.forEach(p => {\n    // -- MOVE ON BELT --\n    if (p.state === 'move') {\n        p.x += SPEED_CONV * dt;\n        p.y = 200 + (p.x * 0.05); \n        \n        // Collision Gate B\n        if (gateClosed && p.x >= STOP_X) {\n            p.x = STOP_X;\n            if (p.type === 'pyr') s_t = true;\n            else s_p = true;\n        }\n        \n        // Fall Bin 2\n        if (p.x > 450) {\n            p.state = 'fall2';\n            p.bin = 2;\n            if(!p.trig_b2) {\n                state.b2_timer = 0.5;\n                p.trig_b2 = true;\n                p.stackIdx = bin2Items.length; \n            }\n        }\n    }\n    \n    // -- PUSHED BY A (Bin 1) --\n    if (p.state === 'move' && Math.abs(p.x - STOP_X) < 20 && state.a_pos > 30) {\n        p.state = 'fall1';\n        p.bin = 1;\n        p.stackIdx = bin1Items.length;\n    }\n    \n    // -- FALL BIN 1 --\n    if (p.state === 'fall1') {\n        const targetY = BIN1_FLOOR - (p.stackIdx * 15);\n        if (p.y < targetY) {\n             p.y += 200 * dt;\n             p.x -= 20 * dt;\n        } else {\n             p.y = targetY;\n             p.state = 'rest';\n        }\n    }\n    \n    // -- FALL BIN 2 --\n    if (p.state === 'fall2') {\n        const targetY = BIN2_FLOOR - (p.stackIdx * 15);\n        if (p.y < targetY) {\n            p.y += 200 * dt;\n            p.x += 80 * dt;\n        } else {\n            p.y = targetY;\n            p.state = 'rest';\n        }\n    }\n});\n\n// --- 4. SENSORS ---\nconst a0 = state.a_pos <= 1;\nconst a1 = state.a_pos >= 99;\nconst b0 = state.b_pos <= 1;\nconst b1 = state.b_pos >= 99;\nconst b2 = state.b2_timer > 0;\n\n// --- 5. VISUALS ---\n\n// Rod A Animation (Visual Logic)\n// Rod length expands based on pos. \n// Max length approx 40. Start Y=0 in local group.\nsvg.querySelector('#rod-a').setAttribute('height', state.a_pos * 0.4);\nsvg.querySelector('#rod-a').setAttribute('y', 40);\n// Plate moves with rod end\nsvg.querySelector('#plate-a').setAttribute('transform', `translate(0, ${state.a_pos * 0.4})`);\n\n// Sensors Color\nconst setSens = (id, val) => svg.querySelector(id).setAttribute('fill', val ? '#00e676' : '#333');\nsetSens('#sens-a0', a0);\nsetSens('#sens-a1', a1);\n\n// Rod B Animation\nconst bLen = state.b_pos * 0.6;\nconst rodB = svg.querySelector('#rod-b');\nrodB.setAttribute('width', bLen);\nrodB.setAttribute('x', -bLen);\nsvg.querySelector('#plate-b').setAttribute('transform', `translate(${-bLen}, 0)`);\nsetSens('#sens-b0', b0);\nsetSens('#sens-b1', b1);\n\n// Render Parts\nconst grp = svg.querySelector('#parts-layer');\ngrp.innerHTML = '';\nstate.parts.forEach(p => {\n    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');\n    g.setAttribute('transform', `translate(${p.x}, ${p.y})`);\n    g.setAttribute('filter', 'url(#shadow-parts)');\n    g.setAttribute('opacity', p.opacity);\n\n    if (p.type === 'pyr') {\n        // Pyramid\n        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n        path.setAttribute('d', 'M 0,20 L 15,-10 L 30,20 L 0,20 Z M 30,20 L 15,-10 L 40,0 L 40,30 L 30,20 Z');\n        path.setAttribute('fill', '#ffeb3b');\n        path.setAttribute('stroke', '#f9a825');\n        path.setAttribute('stroke-linejoin', 'round');\n        g.appendChild(path);\n    } else {\n        // Cube\n        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n        path.setAttribute('d', \n            'M 0,0 L 30,0 L 30,20 L 0,20 Z ' + \n            'M 0,0 L 10,-10 L 40,-10 L 30,0 Z ' + \n            'M 30,0 L 40,-10 L 40,10 L 30,20 Z'\n        );\n        path.setAttribute('fill', '#29b6f6');\n        path.setAttribute('stroke', '#0277bd');\n        path.setAttribute('stroke-linejoin', 'round');\n        g.appendChild(path);\n    }\n    grp.appendChild(g);\n});\n\n// Dashboard\nconst setLed = (id, val) => svg.querySelector(id).setAttribute('fill', val ? '#00e676' : '#ccc');\nsetLed('#led-m', state.m);\n\nconst setTxt = (id, val) => svg.querySelector(id).setAttribute('fill', val ? '#00c853' : '#b0bec5');\nsetTxt('#txt-a0', a0);\nsetTxt('#txt-a1', a1);\nsetTxt('#txt-b0', b0);\nsetTxt('#txt-b1', b1);\nsetTxt('#txt-b2', b2);\n\nconst detLed = svg.querySelector('#led-detect');\nif(s_t) detLed.setAttribute('fill', '#ffeb3b');\nelse if(s_p) detLed.setAttribute('fill', '#29b6f6');\nelse detLed.setAttribute('fill', '#e0e0e0');\n\nreturn {\n    m: state.m,\n    a0: a0,\n    a1: a1,\n    b0: b0,\n    b1: b1,\n    t: s_t,\n    p: s_p,\n    b2: b2\n};",
  "layout": {
    "nodes": {
      "S0": {
        "x": 95,
        "y": 37
      },
      "S1": {
        "x": 20,
        "y": 200
      },
      "S2": {
        "x": 20,
        "y": 380
      },
      "S3": {
        "x": 180,
        "y": 167
      },
      "S4": {
        "x": 182,
        "y": 273
      },
      "S5": {
        "x": 184,
        "y": 391
      },
      "T_0": {
        "x": 20,
        "y": 110
      },
      "T_1": {
        "x": 180,
        "y": 110
      },
      "T_2": {
        "x": 20,
        "y": 290
      },
      "T_3": {
        "x": 19,
        "y": 441
      },
      "T_4": {
        "x": 181,
        "y": 226
      },
      "T_5": {
        "x": 183,
        "y": 324
      },
      "T_6": {
        "x": 184,
        "y": 451
      }
    },
    "loops": {
      "T_3-S0": -99,
      "T_6-S0": 164
    }
  }
}